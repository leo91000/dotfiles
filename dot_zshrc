# Add deno completions to search path
if [[ ":$FPATH:" != *":/home/leoc/.zsh/completions:"* ]]; then export FPATH="/home/leoc/.zsh/completions:$FPATH"; fi
# Check if oh-my-zsh is installed; if not, install it
export ZSH="$HOME/.oh-my-zsh"
if [ ! -d "$ZSH" ]; then
  echo "Installing oh-my-zsh..."
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

ZSH_CUSTOM=${ZSH_CUSTOM:-~/.oh-my-zsh/custom}

HISTFILE=~/.histfile
HISTSIZE=1000
SAVEHIST=1000
setopt autocd nomatch
unsetopt beep extendedglob notify
autoload -Uz compinit
compinit

typeset -U path cdpath fpath manpath

for profile in ${(z)NIX_PROFILES}; do
  fpath+=($profile/share/zsh/site-functions $profile/share/zsh/$ZSH_VERSION/functions $profile/share/zsh/vendor-completions)
done

# Install zsh-autosuggestions if not already installed
if [ ! -d "${ZSH_CUSTOM:-$ZSH/custom}/plugins/zsh-autosuggestions" ]; then
  echo "Installing zsh-autosuggestions..."
  git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-$ZSH/custom}/plugins/zsh-autosuggestions
fi

# Install zsh-history-substring-search if not already installed
if [ ! -d "${ZSH_CUSTOM:-$ZSH/custom}/plugins/zsh-history-substring-search" ]; then
  echo "Installing zsh-history-substring-search..."
  git clone https://github.com/zsh-users/zsh-history-substring-search ${ZSH_CUSTOM:-$ZSH/custom}/plugins/zsh-history-substring-search
fi

# Install zsh-syntax-highlighting if not already installed
if [ ! -d "${ZSH_CUSTOM:-$ZSH/custom}/plugins/zsh-syntax-highlighting" ]; then
  echo "Installing zsh-syntax-highlighting..."
  git clone https://github.com/zsh-users/zsh-syntax-highlighting ${ZSH_CUSTOM:-$ZSH/custom}/plugins/zsh-syntax-highlighting
fi

plugins=(
  git
  npm
  docker
  zsh-autosuggestions
  zsh-history-substring-search
  zsh-syntax-highlighting
)

ZSH_THEME="robbyrussell"
source $ZSH/oh-my-zsh.sh

# History options should be set in .zshrc and after oh-my-zsh sourcing.
# See https://github.com/nix-community/home-manager/issues/177.
HISTSIZE="10000"
SAVEHIST="10000"

HISTFILE="$HOME/.zsh_history"
mkdir -p "$(dirname "$HISTFILE")"

setopt HIST_FCNTL_LOCK
setopt HIST_IGNORE_DUPS
unsetopt HIST_IGNORE_ALL_DUPS
setopt HIST_IGNORE_SPACE
unsetopt HIST_EXPIRE_DUPS_FIRST
setopt SHARE_HISTORY
unsetopt EXTENDED_HISTORY

zstyle ":completion:*" menu select
zstyle ":completion:*" matcher-list "" "m:{a-z0A-Z}={A-Za-z}" "r:|=*" "l:|=* r:|=*"
if type nproc &>/dev/null; then
  export MAKEFLAGS="$MAKEFLAGS -j$(($(nproc)-1))"
fi
bindkey '^[[3~' delete-char                     # Key Del
bindkey '^[[5~' beginning-of-buffer-or-history  # Key Page Up
bindkey '^[[6~' end-of-buffer-or-history        # Key Page Down
bindkey '^[[1;3D' backward-word                 # Key Alt + Left
bindkey '^[[1;3C' forward-word                  # Key Alt + Right
bindkey '^[[H' beginning-of-line                # Key Home
bindkey '^[[F' end-of-line                      # Key End
bindkey '^H' backward-delete-word
stty susp undef                                 # Disable Ctrl+Z suspend
# #neofetch
# export TERM='screen-256color'
if [ -f $HOME/.zshrc-personal ]; then
  source $HOME/.zshrc-personal
fi

# Automatically install tmux tpm if not present
if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
  echo "Installing tmux tpm..."
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
fi

# zed or vscode
if [ "$TERM_PROGRAM" != "zed" ] && [ "$TERM_PROGRAM" != "vscode" ] && [ "$TERM_PROGRAM" != "WarpTerminal" ]; then
  # Start tmux if no TMUX is running
  if [ -z "$TMUX" ]; then
    # Ensure tpm plugins are installed and updated before starting tmux
    tmux_plugins_dir="$HOME/.tmux/plugins"
    tpm_dir="$tmux_plugins_dir/tpm"

    # Count the number of plugin directories excluding tpm
    plugin_count=$(fd --type d --max-depth 1 --exclude tpm . "$tmux_plugins_dir" | wc -l)

    if [ "$plugin_count" -eq 0 ]; then
      echo "Installing tmux plugins..."
      bash "$HOME/.tmux/plugins/tpm/scripts/install_plugins.sh" &>/dev/null
    fi

    tmux has-session -t main 2>/dev/null
    if [ $? -eq 0 ]; then
      echo "Attaching to tmux session 'main'..."
      tmux attach -t main
    else
      echo "Creating tmux session 'main'..."
      tmux new-session -s main
    fi
  fi
fi

# Aliases
alias ..='cd ..'
alias gA='git add -A'
alias ga='git add'
alias gb='git branch'
alias gbd='git branch -d'
alias gbD='git branch -D'
alias gc='git commit'
alias gca='git commit -a'
alias gcam='git add -A && git commit -m'
alias gcl='git clone'
alias gcm='git commit -m'
alias gco='git checkout'
alias gcob='git checkout -b'
alias gfrb='git fetch origin && git rebase origin/main'
alias ghci='gh run list -L 1'
alias gl='git log'
alias glo='git log --oneline --graph'
alias gmv='git mv'
alias gp='git push'
alias gpf='git push --force'
alias gpft='git push --follow-tags'
alias gpl='git pull --rebase'
alias grb='git rebase'
alias grbc='git rebase --continue'
alias grbom='git rebase origin/main'
alias grh='git reset HEAD'
alias grh1='git reset HEAD~1'
alias grm='git rm'
alias grt='cd "$(git rev-parse --show-toplevel)"'
alias gs='git status'
alias gsha='git rev-parse HEAD | pbcopy'
alias gst='git stash'
alias gx='git clean -df'
alias gxn='git clean -dn'
alias la='lsd -a'
alias lal='lsd -al'
alias ll='lsd -l'
alias ls='lsd'
alias main='git checkout main'
alias nd='nix develop -c $SHELL'
sv() {
  if [ $# -eq 0 ]; then
    sudo XDG_CONFIG_HOME=$HOME/.config XDG_DATA_HOME=$HOME/.local/share nvim .
  else
    sudo XDG_CONFIG_HOME=$HOME/.config XDG_DATA_HOME=$HOME/.local/share nvim "$@"
  fi
}
alias p='cd ~/projects'
v() {
  if [ $# -eq 0 ]; then
    nvim .
  else
    nvim "$@"
  fi
}
alias vo='cd ~/Documents/obsidian-vault/Tech && nvim . && cd -'
alias r='source ~/.zshrc'
alias nd='nix develop -c $SHELL'
alias cm="chezmoi"
alias cme="chezmoi edit --apply"
alias cma="chezmoi add"
alias cmez="chezmoi edit --apply ~/.zshrc"
alias cmen="cd ~/.config/nvim && chezmoi edit --apply ~/.config/nvim && cd -"
alias cmezed="chezmoi edit ~/.config/zed"
alias cmazed="chezmoi add ~/.config/zed"
alias cmem="chezmoi edit --apply ~/.config/mise/config.toml"
alias cmam="chezmoi add --apply ~/.config/mise/config.toml"
alias cmu="chezmoi update"
alias cmcd="cd ~/.local/share/chezmoi"
edit_prompt() {
  $EDITOR ~/.local/share/chezmoi/.chezmoitemplates/agents.md && \
  chezmoi apply && \
  cd ~/.local/share/chezmoi && \
  git add .chezmoitemplates/agents.md && \
  (git commit -m "chore: update AI agent prompt" && git push || echo "No changes to commit") && \
  cd -
}
alias cdl="cd ~/projects/leo91000"
alias cdle="cd ~/projects/leo91000/eliah"
alias cdc="cd ~/projects/contribs"
alias node_modules_clear='fd node_modules -t d -I -X rm -rf && rm -f package-lock.json && rm -f yarn.lock && rm -f pnpm-lock.yaml'
alias npm_reset_lockfile='node_modules_clear && npm i'
alias pnpm_reset_lockfile='node_modules_clear && pnpm i'
alias git-clone-org='~/scripts/git-clone-org.sh'
alias d='dolphin . &>/dev/null & disown'
alias dc='docker compose'
alias dcw='docker compose -p weweb-docker'
alias dce='docker compose -p eliah'
alias cc='claude'
alias ralphy='~/projects/contribs/michaelshimeles/ralphy/ralphy.sh'
alias ralphyu='cd ~/projects/contribs/michaelshimeles/ralphy && git pull && chmod +x ralphy.sh cd -'

# WeWeb helpers
if [ -f "$HOME/.config/zsh/weweb.zsh" ]; then
  source "$HOME/.config/zsh/weweb.zsh"
fi

# Make sure to use nvim as the default editor
export EDITOR=nvim

# Named Directory Hashes
ZSH_HIGHLIGHT_HIGHLIGHTERS+=()

bindkey "^[[A" history-substring-search-up
bindkey "^[[B" history-substring-search-down

if [ -f "$HOME/.cargo/env" ]; then
  source $HOME/.cargo/env
fi

PATH="$PATH":"$HOME/scripts/"

export MISE_NODE_COREPACK='true'
export MISE_POETRY_AUTO_INSTALL='true'
eval "$(mise activate zsh)"
CFLAGS="-std=c99 -Wno-misleading-indentation" CPPFLAGS="-std=c99 -Wno-misleading-indentation" mise install 2>/dev/null

# Reduce delay when changing modes (from insert to normal)
export KEYTIMEOUT=1

if [ ! -d "$HOME/.bun" ]; then
    echo "Installing bun..."
    curl -fsSL https://bun.sh/install | bash
fi

[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"

export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

if [ ! -d "$HOME/.deno" ]; then
    echo "Installing deno..."
    curl -fsSL https://deno.land/install.sh | sh
fi
. "$HOME/.deno/env"

export PATH=$HOME/.opencode/bin:$PATH
export PATH=$HOME/.local/bin:$PATH

# Turso
export PATH="$PATH:/home/leoc/.turso"

# bun completions
[ -s "/home/leoc/.bun/_bun" ] && source "/home/leoc/.bun/_bun"
